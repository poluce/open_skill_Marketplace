<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æŠ€èƒ½å¸‚åœº</title>
    <style>
      :root {
          --accent-color: {{accentColor}};
          --accent-glow: {{accentGlow}};
          --card-bg: var(--vscode-welcomePage-tileBackground, rgba(255, 255, 255, 0.05));
          --text-main: var(--vscode-foreground);
          --text-dim: var(--vscode-descriptionForeground);
      }

      body {
          font-family: var(--vscode-font-family);
          padding: 0;
          margin: 0;
          color: var(--text-main);
          background-color: transparent;
          overflow-x: hidden;
          user-select: none;
      }

      .container {
          display: flex;
          flex-direction: column;
          padding: 12px;
          gap: 16px;
      }

      .search-container {
          position: sticky;
          top: 0;
          z-index: 100;
          background: var(--vscode-sideBar-background);
          padding-bottom: 8px;
          display: flex;
          gap: 8px;
          align-items: center;
      }

      .search-box {
          display: flex;
          align-items: center;
          background: rgba(255, 255, 255, 0.05);
          border: 1px solid var(--vscode-input-border, transparent);
          border-radius: 6px;
          padding: 2px 10px;
          transition: all 0.3s ease;
          flex: 1;
      }

      .search-box:focus-within {
          border-color: var(--accent-color);
          box-shadow: 0 0 8px var(--accent-glow);
      }

      .search-input {
          background: transparent;
          border: none;
          color: var(--text-main);
          padding: 8px;
          width: 100%;
          outline: none;
          font-size: 13px;
      }

      .lang-select {
          background: rgba(255, 255, 255, 0.05);
          border: 1px solid var(--vscode-input-border, transparent);
          border-radius: 6px;
          padding: 6px 8px;
          color: var(--text-main);
          font-size: 11px;
          cursor: pointer;
          outline: none;
          min-width: 60px;
      }

      .lang-select:hover {
          background: rgba(255, 255, 255, 0.1);
      }

      .lang-select:focus {
          border-color: var(--accent-color);
      }

      /* ç¿»è¯‘è¿›åº¦æ¡ */
      .translation-progress {
          padding: 8px 4px;
          background: rgba(255, 255, 255, 0.03);
          border-radius: 6px;
          margin-top: -4px;
          margin-bottom: 8px;
      }

      .progress-info {
          display: flex;
          justify-content: space-between;
          font-size: 10px;
          margin-bottom: 4px;
          opacity: 0.8;
      }

      .progress-track {
          height: 4px;
          background: rgba(255, 255, 255, 0.1);
          border-radius: 2px;
          overflow: hidden;
      }

      .progress-fill {
          height: 100%;
          background: var(--accent-color);
          width: 0%;
          transition: width 0.3s ease;
      }

      .categories {
          display: flex;
          gap: 8px;
          overflow-x: auto;
          padding-bottom: 4px;
          scrollbar-width: none;
      }

      .categories::-webkit-scrollbar {
          display: none;
      }

      .category-chip {
          padding: 4px 12px;
          background: rgba(255, 255, 255, 0.08);
          border-radius: 12px;
          font-size: 11px;
          white-space: nowrap;
          cursor: pointer;
          transition: all 0.2s;
          border: 1px solid transparent;
      }

      .category-chip.active {
          background: linear-gradient(135deg, #6366f1, #8b5cf6);
          color: white;
          box-shadow: 0 2px 6px rgba(99, 102, 241, 0.4);
      }

      .category-chip:hover:not(.active) {
          background: rgba(255, 255, 255, 0.15);
      }

      /* äºŒçº§ç­›é€‰å™¨æ ·å¼ */
      .sub-filter-container {
          display: none;
          gap: 6px;
          margin-top: 8px;
          padding-left: 4px;
          flex-wrap: wrap;
      }

      .sub-filter-container.visible {
          display: flex;
      }

      .sub-filter-chip {
          padding: 3px 10px;
          background: rgba(255, 255, 255, 0.06);
          border-radius: 10px;
          font-size: 10px;
          white-space: nowrap;
          cursor: pointer;
          transition: all 0.2s;
          border: 1px solid transparent;
          display: flex;
          align-items: center;
          gap: 4px;
      }

      .sub-filter-chip.active {
          background: rgba(99, 102, 241, 0.45);
          border-color: rgba(99, 102, 241, 0.7);
          box-shadow: 0 1px 4px rgba(99, 102, 241, 0.2);
          color: white;
      }

      .sub-filter-chip:hover:not(.active) {
          background: rgba(255, 255, 255, 0.12);
      }

      .sub-filter-chip .source-icon {
          width: 14px;
          height: 14px;
          border-radius: 3px;
          overflow: hidden;
      }

      .skill-list {
          display: flex;
          flex-direction: column;
          gap: 12px;
      }

      .skill-card {
          position: relative;
          height: 72px;
          /* å›ºå®šé«˜åº¦ä½œä¸ºå ä½ç¬¦ï¼Œå½»åº•æ¶ˆé™¤è·³åŠ¨ */
      }

      .skill-card-content {
          display: flex;
          align-items: flex-start;
          gap: 12px;
          background: var(--card-bg);
          border: 1px solid rgba(255, 255, 255, 0.05);
          padding: 12px;
          border-radius: 8px;
          cursor: default;
          width: 100%;
          height: 100%;
          /* éæ‚¬æµ®æ—¶å æ»¡ 72px */
          box-sizing: border-box;
          z-index: 1;
          overflow: hidden;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          max-height: 72px;
          /* æ˜¾å¼é™åˆ¶é«˜åº¦ */
      }

      /* æ­£å¸¸æƒ…å†µä¸‹ä½¿ç”¨ :hoverï¼Œæ»šåŠ¨æ—¶ç¦ç”¨ :hover åªç”¨ .hovered */
      .skill-list:not(.scrolling) .skill-card:hover .skill-card-content,
      .skill-card.hovered .skill-card-content {
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: auto;
          max-height: 400px;
          /* å¢åŠ æœ€å¤§é«˜åº¦é™åˆ¶ */
          z-index: 1000;
          /* å…³é”®ï¼šæ¶ˆé™¤ä½ç§»å’Œç¼©æ”¾ï¼Œä¿æŒåŸåœ°å±•å¼€ */
          transform: none;
          background: var(--vscode-sideBar-background);
          border: 1px solid var(--accent-color);
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
          /* é€‚åº¦é˜´å½± */
          backdrop-filter: blur(12px);
          padding-bottom: 12px;
      }

      .skill-icon {
          width: 40px;
          height: 40px;
          background: linear-gradient(135deg, var(--accent-color), #00BFFF);
          border-radius: 10px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 20px;
          flex-shrink: 0;
          box-shadow: 0 2px 8px var(--accent-glow);
          margin-top: 2px;
          /* é¡¶éƒ¨å¯¹é½æ—¶çš„å¾®è°ƒ */
      }

      .btn-group {
          display: flex;
          flex-wrap: wrap;
          gap: 4px;
          margin-top: 4px;
          justify-content: flex-end;
          margin-left: auto;
          flex-shrink: 0;
          width: fit-content;
          max-width: 150px;
      }

      .skill-info {
          flex-grow: 1;
          min-width: 0;
      }

      .skill-name {
          font-weight: 600;
          font-size: 13px;
          margin-bottom: 2px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
      }

      .skill-desc {
          font-size: 11px;
          color: var(--text-dim);
          line-height: 1.4;
          display: -webkit-box;
          -webkit-line-clamp: 2;
          line-clamp: 2;
          -webkit-box-orient: vertical;
          overflow: hidden;
          transition: all 0.3s ease;
      }

      .skill-list:not(.scrolling) .skill-card:hover .skill-desc,
      .skill-card.hovered .skill-desc {
          -webkit-line-clamp: unset;
          line-clamp: unset;
          overflow: visible;
      }

      .btn-install {
          background-color: var(--accent-color, #8A2BE2);
          color: white;
          border: none;
          padding: 3px 12px;
          border-radius: 4px;
          font-size: 11px;
          font-weight: 500;
          cursor: pointer;
          transition: opacity 0.2s;
          flex-shrink: 0;
          white-space: nowrap;
          height: 24px;
          display: flex;
          align-items: center;
          justify-content: center;
      }

      .btn-install:hover {
          opacity: 0.85;
      }

      .featured-tag {
          display: inline-flex;
          align-items: center;
          background: linear-gradient(135deg, #6366f1, #8b5cf6);
          color: white;
          font-size: 10px;
          padding: 1px 5px;
          border-radius: 4px;
          font-weight: 500;
          margin-left: 6px;
          vertical-align: middle;
          height: 16px;
          line-height: 16px;
      }

      .skill-header {
          display: flex;
          align-items: center;
          margin-bottom: 2px;
      }

      /* ç§»é™¤é‡å¤çš„ .btn-group å®šä¹‰ï¼Œå·²åˆå¹¶åˆ°ä¸Šæ–¹ */

      .btn-outline {
          background: transparent;
          border: 1px solid var(--accent-color);
          color: var(--accent-color);
          padding: 3px 12px;
          border-radius: 4px;
          font-size: 11px;
          cursor: pointer;
          transition: all 0.2s;
          white-space: nowrap;
          height: 24px;
          display: flex;
          align-items: center;
          justify-content: center;
          box-sizing: border-box;
      }

      .btn-outline:hover {
          background: rgba(255, 255, 255, 0.05);
      }

      .skill-card.featured {
          border-color: rgba(99, 102, 241, 0.3);
      }

      /* å·²åˆ é™¤ .category-chip.featured-chip.active ç‰¹æ®Šæ ·å¼,ç»Ÿä¸€ä½¿ç”¨ .category-chip.active */

      @keyframes pulse {
          0% {
              opacity: 0.6;
          }

          50% {
              opacity: 1;
          }

          100% {
              opacity: 0.6;
          }
      }

      .loading {
          animation: pulse 1.5s infinite;
      }

      .section-header {
          font-size: 11px;
          font-weight: 600;
          color: var(--text-dim);
          text-transform: uppercase;
          padding: 8px 0 4px;
          margin-top: 4px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
          letter-spacing: 0.5px;
      }

      /* Tab åˆ‡æ¢æ ·å¼ */
      .tabs {
          display: flex;
          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
          margin-bottom: 12px;
          gap: 16px;
      }

      .tab {
          padding: 8px 4px;
          font-size: 12px;
          cursor: pointer;
          color: var(--text-dim);
          position: relative;
          transition: color 0.2s;
          font-weight: 500;
      }

      .tab.active {
          color: var(--accent-color);
      }

      .tab.active::after {
          content: '';
          position: absolute;
          bottom: -1px;
          left: 0;
          right: 0;
          height: 2px;
          background: var(--accent-color);
          box-shadow: 0 0 8px var(--accent-glow);
      }

      .tab-count {
          margin-left: 4px;
          opacity: 0.6;
          font-size: 10px;
      }

      /* ç§»é™¤ .btn-installed æ ·å¼ï¼Œä¸å†ä½¿ç”¨ */

      .btn-uninstall {
          background: transparent;
          border: 1px solid #ef4444;
          color: #ef4444;
          padding: 3px 12px;
          border-radius: 4px;
          font-size: 11px;
          cursor: pointer;
          transition: all 0.2s;
          white-space: nowrap;
          height: 24px;
          display: flex;
          align-items: center;
          justify-content: center;
          box-sizing: border-box;
      }

      .btn-uninstall:hover {
          background: rgba(239, 68, 68, 0.1);
      }

      /* ç§»é™¤ .skill-card.installed é€æ˜åº¦ï¼Œä¿æŒæ¸…æ™° */

      /* åŠ è½½å™¨æ ·å¼ */
      .loader-container {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: 60px 20px;
          opacity: 0.7;
      }

      .loader {
          width: 30px;
          height: 30px;
          border: 3px solid rgba(var(--accent-color-rgb, 138, 43, 226), 0.2);
          border-top: 3px solid var(--accent-color);
          border-radius: 50%;
          animation: spin 1s linear infinite;
          margin-bottom: 12px;
      }

      @keyframes spin {
          0% {
              transform: rotate(0deg);
          }

          100% {
              transform: rotate(360deg);
          }
      }

      /* è­¦å‘Šæ¡æ ·å¼ */
      .warning-banner {
          display: none;
          background: rgba(255, 165, 0, 0.1);
          border: 1px solid rgba(255, 165, 0, 0.3);
          color: #ffa500;
          padding: 8px 12px;
          border-radius: 6px;
          margin-bottom: 16px;
          font-size: 11px;
          line-height: 1.4;
          align-items: flex-start;
          gap: 8px;
      }

      .warning-banner i {
          font-style: normal;
          font-weight: bold;
          font-size: 14px;
      }

      .warning-btn {
          cursor: pointer;
          background: var(--accent-color);
          color: white;
          border: none;
          padding: 2px 8px;
          border-radius: 4px;
          font-size: 10px;
          margin-top: 6px;
          display: inline-block;
          transition: opacity 0.2s;
      }

      .warning-btn:hover {
          opacity: 0.9;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div id="warningBanner" class="warning-banner">
        <i>âš ï¸</i>
        <div>
          <div>
            ç”±äºè®¿é—® GitHub API è¿‡äºé¢‘ç¹ (60æ¬¡/h)ï¼Œå½“å‰åŠ è½½çš„æ˜¯æœ¬åœ°ç¼“å­˜ã€‚é…ç½®
            Token å¯è§£å°ã€‚
          </div>
          <button class="warning-btn" onclick="configureToken()">
            ç«‹å³è®¾ç½® Token
          </button>
        </div>
      </div>
      <div class="search-container" style="flex-direction: column; align-items: stretch; gap: 8px;">
        <!-- ç¬¬ä¸€è¡Œï¼šæœç´¢æ¡† + è¯­è¨€é€‰æ‹© + åˆ†ç±»å¼€å…³ -->
        <div style="display: flex; gap: 8px; align-items: center; width: 100%;">
            <div class="search-box">
              <span style="opacity: 0.5">ğŸ”</span>
              <input
                type="text"
                id="searchInput"
                class="search-input"
                placeholder="æœç´¢æŠ€èƒ½..."
                oninput="updateUI()"
              />
            </div>
            <select id="langSelect" class="lang-select" onchange="onLangChange()">
              <option value="">åŸæ–‡</option>
              <option value="zh-CN">ä¸­æ–‡</option>
            </select>
            <div style="display: flex; align-items: center; gap: 4px; font-size: 11px; opacity: 0.8; margin-left: 2px;">
                <input type="checkbox" id="aiCategoriesToggle" onchange="onToggleAiCategories()" style="cursor: pointer"/>
                <label for="aiCategoriesToggle" style="cursor: pointer; white-space: nowrap">åˆ†ç±»</label>
            </div>
        </div>
        
        <!-- ç¬¬äºŒè¡Œï¼šæ ‡ç­¾ + Agent é€‰æ‹© + èŒƒå›´é€‰æ‹© -->
        <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 11px; opacity: 0.7; white-space: nowrap;">å®‰è£…ä½ç½®:</span>
            <div style="display: flex; gap: 4px; flex: 1;">
                <select id="agentTypeSelect" class="lang-select" onchange="onAgentTypeChange()" title="ç›®æ ‡ Agent" style="flex: 1;">
                    <option value="antigravity">Antigravity</option>
                    <option value="claude">Claude</option>
                    <option value="codex">Codex</option>
                    <option value="opencode">OpenCode</option>
                </select>
                <select id="scopeSelect" class="lang-select" onchange="onScopeChange()" title="å®‰è£…ä½ç½®" style="flex: 1;">
                    <option value="global">å…¨å±€</option>
                    <option value="project">é¡¹ç›®</option>
                </select>
            </div>
        </div>
      </div>

      <div
        id="translationProgress"
        class="translation-progress"
        style="display: none"
      >
        <div class="progress-info">
          <span>æ­£åœ¨ç¿»è¯‘æŠ€èƒ½æè¿°...</span>
          <span id="progressPercent">0%</span>
        </div>
        <div class="progress-track">
          <div id="progressFill" class="progress-fill" style="width: 0%"></div>
        </div>
      </div>

      <!-- Tab åˆ‡æ¢ (æå‡ä¸ºä¸»å¯¼èˆª) -->
      <div class="tabs">
        <div class="tab active" id="tabAvailable" onclick="setTab('available')">
          å¯å®‰è£…<span class="tab-count" id="countAvailable">0</span>
        </div>
        <div class="tab" id="tabInstalled" onclick="setTab('installed')">
          å·²å®‰è£…<span class="tab-count" id="countInstalled">0</span>
        </div>
      </div>

      <!-- ä»¥ä¸‹ç­›é€‰å™¨åœ¨è§†è§‰ä¸Šå±äº Tab å†…éƒ¨å†…å®¹ -->
      <div class="categories" id="categoryContainer">
        <div class="category-chip active" onclick="setCategory('å…¨éƒ¨')">
          å…¨éƒ¨
        </div>
        <div class="category-chip featured-chip" onclick="setCategory('é«˜èµ')">
          âœ“ é«˜èµ
        </div>
        <div class="category-chip ai-category" onclick="setCategory('ç¼–ç¨‹')">
          ç¼–ç¨‹
        </div>
        <div class="category-chip ai-category" onclick="setCategory('åŠå…¬')">
          åŠå…¬
        </div>
        <div class="category-chip ai-category" onclick="setCategory('åˆ›æ„')">
          åˆ›æ„
        </div>
        <div class="category-chip ai-category" onclick="setCategory('åˆ†æ')">
          åˆ†æ
        </div>
        <div class="category-chip ai-category" onclick="setCategory('ç”Ÿæ´»')">
          ç”Ÿæ´»
        </div>
      </div>

      <!-- äºŒçº§ç­›é€‰å™¨ï¼šé«˜èµæŠ€èƒ½æº -->
      <div class="sub-filter-container" id="sourceFilterContainer">
        <div
          class="sub-filter-chip active"
          data-source="å…¨éƒ¨"
          onclick="setSourceFilter('å…¨éƒ¨')"
        >
          å…¨éƒ¨
        </div>
        <div
          class="sub-filter-chip"
          data-source="anthropic"
          onclick="setSourceFilter('anthropic')"
        >
          <span class="source-icon" style="background: #d7764f"></span>
          Anthropic
        </div>
        <div
          class="sub-filter-chip"
          data-source="openai"
          onclick="setSourceFilter('openai')"
        >
          <span class="source-icon" style="background: #10a37f"></span> OpenAI
        </div>
        <div
          class="sub-filter-chip"
          data-source="huggingface"
          onclick="setSourceFilter('huggingface')"
        >
          <span class="source-icon" style="background: #ffd21e"></span>
          HuggingFace
        </div>
        <div
          class="sub-filter-chip"
          data-source="superpowers"
          onclick="setSourceFilter('superpowers')"
        >
          <span class="source-icon" style="background: #ff6b35"></span>
          Superpowers
        </div>
        <div
          class="sub-filter-chip"
          data-source="composio"
          onclick="setSourceFilter('composio')"
        >
          <span class="source-icon" style="background: #7c3aed"></span> Composio
        </div>
      </div>

      <div class="skill-list" id="skillList">
        <div class="loader-container" id="loader">
          <div class="loader"></div>
          <div style="font-size: 11px; opacity: 0.6">æ­£åœ¨æŠ“å–å®˜æ–¹æŠ€èƒ½åº“...</div>
        </div>
      </div>
    </div>

    <script>
      const vscode = acquireVsCodeApi();
      const oldState = vscode.getState() || {};
      let currentCategory = oldState.category || "å…¨éƒ¨";
      let currentSourceFilter = oldState.source || "å…¨éƒ¨";
      let currentTab = oldState.tab || "available";
      let currentLanguage = "/*{{currentLang}}*/";
      let showAiCategories = "/*{{showAiCategories}}*/" === "true";
      let currentAgentType = "/*{{currentAgentType}}*/";
      let currentScope = "/*{{currentScope}}*/";

      let skills = [
        /*{{skillsData}}*/
      ];

      // åˆå§‹åŒ– UI çŠ¶æ€
      document.getElementById("langSelect").value = currentLanguage;
      document.getElementById("aiCategoriesToggle").checked = showAiCategories;
      document.getElementById("agentTypeSelect").value = currentAgentType || "antigravity";
      document.getElementById("scopeSelect").value = currentScope || "global";
      updateAiCategoriesVisibility();

      function onAgentTypeChange() {
        currentAgentType = document.getElementById("agentTypeSelect").value;
        vscode.postMessage({ command: "setAgentType", agentType: currentAgentType });
        saveState();
      }

      function onScopeChange() {
        currentScope = document.getElementById("scopeSelect").value;
        vscode.postMessage({ command: "setScope", scope: currentScope });
        saveState();
      }

      function saveState() {
        vscode.setState({
          category: currentCategory,
          source: currentSourceFilter,
          tab: currentTab,
          language: currentLanguage,
          showAiCategories: showAiCategories,
          agentType: currentAgentType,
          scope: currentScope
        });
      }

      function onToggleAiCategories() {
        showAiCategories =
          document.getElementById("aiCategoriesToggle").checked;
        vscode.postMessage({
          command: "setShowAiCategories",
          show: showAiCategories,
        });
        updateAiCategoriesVisibility();

        // å¦‚æœå½“å‰æ­£å¥½é€‰ä¸­äº†è¢«éšè—çš„ AI åˆ†ç±»ï¼Œè‡ªåŠ¨åˆ‡å›â€œå…¨éƒ¨â€
        const aiCategories = ["ç¼–ç¨‹", "åŠå…¬", "åˆ›æ„", "åˆ†æ", "ç”Ÿæ´»"];
        if (!showAiCategories && aiCategories.includes(currentCategory)) {
          setCategory("å…¨éƒ¨");
        } else {
          updateUI();
        }
        saveState();
      }

      function updateAiCategoriesVisibility() {
        const chips = document.querySelectorAll(".ai-category");
        chips.forEach((chip) => {
          chip.style.display = showAiCategories ? "block" : "none";
        });
      }

      function configureToken() {
        vscode.postMessage({ command: "configureToken" });
      }

      function onLangChange() {
        currentLanguage = document.getElementById("langSelect").value;
        vscode.postMessage({ command: "setLanguage", lang: currentLanguage });
        updateUI();
        saveState();
      }

      function updateUI() {
        const query = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const list = document.getElementById("skillList");

        // åªæœ‰åœ¨æœ‰æ•°æ®æˆ–æ˜ç¡®æ˜¾ç¤ºä¸ºç©ºæ—¶æ‰æ¸…ç©ºï¼Œé¿å…åŠ è½½ä¸­é—ªçƒ
        const loader = document.getElementById("loader");
        if (skills.length > 0 || (loader && loader.style.display === "none")) {
          list.innerHTML = "";
        } else if (loader) {
          return; // è¿˜åœ¨åŠ è½½ä¸­ä¸”æ— æ•°æ®
        }

        const filtered = skills.filter((s) => {
          const matchesQuery =
            s.name.toLowerCase().includes(query) ||
            s.desc.toLowerCase().includes(query);

          // åˆ†ç±»é€»è¾‘é‡æ„ï¼šå¦‚æœå¼€å¯äº† AI åˆ†ç±»ä¸”å­˜åœ¨ aiCategoryï¼Œåˆ™ä¼˜å…ˆä½¿ç”¨å®ƒ
          const actualCategory =
            showAiCategories && s.aiCategory ? s.aiCategory : s.category;

          // è¿‡æ»¤é€»è¾‘ï¼šå¦‚æœé€‰ä¸­â€œé«˜èµâ€ï¼Œå±•ç¤ºæ‰€æœ‰ isFeatured æŠ€èƒ½ï¼›å¦åˆ™åŒ¹é…é€‰ä¸­åˆ†ç±»
          const matchesCategory =
            currentCategory === "å…¨éƒ¨" ||
            (currentCategory === "é«˜èµ"
              ? s.isFeatured
              : actualCategory === currentCategory);

          const matchesSource =
            currentCategory !== "é«˜èµ" ||
            currentSourceFilter === "å…¨éƒ¨" ||
            s.source === currentSourceFilter;
          return matchesQuery && matchesCategory && matchesSource;
        });

        // åˆ†ç¦»å¹¶æ›´æ–° Tab è®¡æ•°
        const installed = filtered.filter((s) => s.isInstalled);
        const available = filtered.filter((s) => !s.isInstalled);

        document.getElementById("countAvailable").innerText = available.length;
        document.getElementById("countInstalled").innerText = installed.length;

        // 'available' Tab æ˜¾ç¤ºå…¨é‡æŠ€èƒ½ï¼ˆæ–¹ä¾¿å®‰è£…åç›´æ¥ç®¡ç†ï¼‰ï¼Œ'installed' åªæ˜¾ç¤ºå·²å®‰è£…
        const displayList = currentTab === "installed" ? installed : filtered;

        if (displayList.length === 0) {
          list.innerHTML = `<div style="text-align:center; padding: 40px; opacity:0.5;">
                  ${
                    currentTab === "installed"
                      ? "æš‚æ— å·²å®‰è£…æŠ€èƒ½"
                      : "æœªå‘ç°åŒ¹é…çš„æŠ€èƒ½"
                  }
              </div>`;
          return;
        }

        displayList.forEach((s) => list.appendChild(createSkillCard(s)));
      }

      function createSkillCard(s) {
        const card = document.createElement("div");
        card.className = s.isFeatured ? "skill-card featured" : "skill-card";
        if (s.isInstalled) card.className += " installed";

        const sourceMap = {
          anthropic: "Anthropic",
          openai: "OpenAI",
          huggingface: "HuggingFace",
          superpowers: "Superpowers",
          composio: "Composio",
        };
        const sourceDisplayName =
          sourceMap[s.source] ||
          (s.source
            ? s.source.charAt(0).toUpperCase() + s.source.slice(1)
            : "");
        const featuredTag = s.isFeatured
          ? `<span class="featured-tag">èµ</span>`
          : "";

        const repoBtn =
          s.isFeatured && s.repoLink
            ? `<button class="btn-outline" onclick="openRepo('${s.repoLink}')">æŸ¥çœ‹</button>`
            : "";

        const actionBtn = s.isInstalled
          ? `<button class="btn-uninstall" onclick="uninstallSkill('${s.id}', '${s.name}')">åˆ é™¤</button>`
          : `<button class="btn-install" onclick="installSkill('${s.id}', '${s.name}')">å®‰è£…</button>`;

        // OpenAI å®˜æ–¹å›¾æ ‡ SVG (ç”±ç”¨æˆ·æä¾›)
        const openaiIcon = `<svg fill="#10a37f" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="100%" height="100%"><rect width="24" height="24" fill="#ffffff" rx="2"/><path d="M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142.0852 4.783 2.7582a.7712.7712 0 0 0 .7806 0l5.8428-3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.872zm16.5963 3.8558L13.1038 8.364 15.1192 7.2a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.407-.667zm2.0107-3.0231l-.142-.0852-4.7735-2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0742a4.4992 4.4992 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.0976-2.3654l2.602-1.4998 2.6069 1.4998v2.9994l-2.5974 1.4997-2.6067-1.4997Z"/></svg>`;

        // Anthropic å®˜æ–¹å›¾æ ‡ SVG (ç»“æ„å¢å¼ºç´§å‡‘ç‰ˆ)
        const anthropicIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="100%" height="100%"><rect width="100" height="100" fill="#D7764F" rx="10"/><g fill="#000"><path d="M40,25 L20,75 L28,75 L48,25 Z"/><path d="M48,25 L68,75 L60,75 L40,25 Z"/><path d="M28,58 L52,58 L54,63 L30,63 Z"/><path d="M62,25 L70,25 L90,75 L82,75 Z"/></g></svg>`;

        const isAnthropic =
          s.repoLink && s.repoLink.includes("anthropics/skills");
        const isOpenAI = s.repoLink && s.repoLink.includes("openai/skills");

        let iconContent = s.icon;
        let bgStyle = `background: linear-gradient(135deg, ${s.colors[0]}, ${s.colors[1]})`;

        if (isAnthropic) {
          iconContent = anthropicIcon;
          bgStyle = "background: none; box-shadow: none;";
        } else if (isOpenAI) {
          iconContent = openaiIcon;
          bgStyle = "background: none; box-shadow: none;";
        }

        card.innerHTML = `
              <div class="skill-card-content">
                  <div class="skill-icon" style="${bgStyle}">${iconContent}</div>
                  <div class="skill-info">
                      <div class="skill-header">
                          <div class="skill-name">${s.name}</div>
                      </div>
                      <div class="skill-desc">${
                        currentLanguage === "zh-CN" && s.translatedDesc
                          ? s.translatedDesc
                          : s.desc
                      }</div>
                  </div>
                  <div class="btn-group">
                      ${repoBtn}
                      ${actionBtn}
                  </div>
              </div>
          `;
        return card;
      }

      function setCategory(cat) {
        currentCategory = cat;
        saveState();
        document.querySelectorAll(".category-chip").forEach((chip) => {
          const baseText = chip.innerText.replace("âœ“ ", "").trim();
          chip.classList.toggle("active", baseText === cat);
        });
        // æ˜¾ç¤º/éšè—äºŒçº§ç­›é€‰å™¨
        const sourceContainer = document.getElementById(
          "sourceFilterContainer"
        );
        if (cat === "é«˜èµ") {
          sourceContainer.classList.add("visible");
        } else {
          sourceContainer.classList.remove("visible");
          currentSourceFilter = "å…¨éƒ¨";
          saveState();
          // é‡ç½®äºŒçº§ç­›é€‰å™¨é€‰ä¸­çŠ¶æ€
          document.querySelectorAll(".sub-filter-chip").forEach((chip, i) => {
            chip.classList.toggle("active", i === 0);
          });
        }
        updateUI();
      }

      function setSourceFilter(source) {
        currentSourceFilter = source;
        saveState();
        document.querySelectorAll(".sub-filter-chip").forEach((chip) => {
          const chipSource = chip.getAttribute("data-source");
          chip.classList.toggle("active", chipSource === source);
        });
        updateUI();
      }

      function setTab(tab) {
        currentTab = tab;
        saveState();
        document
          .getElementById("tabAvailable")
          .classList.toggle("active", tab === "available");
        document
          .getElementById("tabInstalled")
          .classList.toggle("active", tab === "installed");
        updateUI();
      }

      function installSkill(id, name) {
        vscode.postMessage({
          command: "install",
          skillId: id,
          skillName: name,
        });
      }

      function uninstallSkill(id, name) {
        vscode.postMessage({
          command: "uninstall",
          skillId: id,
          skillName: name,
        });
      }

      function openRepo(url) {
        vscode.postMessage({ command: "openRepo", url: url });
      }

      updateUI();

      setCategory(currentCategory);
      setTab(currentTab);
      updateUI();

      // é€šçŸ¥æ’ä»¶ WebView å·²å°±ç»ªï¼Œè¯·æ±‚å…¨é‡æ•°æ®åŒæ­¥
      vscode.postMessage({ command: "ready" });

      // è®°å½•é¼ æ ‡ä½ç½®ï¼Œç”¨äºæ»šè½®æ»šåŠ¨æ—¶æ›´æ–°æ‚¬æµ®çŠ¶æ€
      let lastMouseX = 0;
      let lastMouseY = 0;

      document.addEventListener('mousemove', (e) => {
        lastMouseX = e.clientX;
        lastMouseY = e.clientY;
        // å¦‚æœå½“å‰æœ‰ hovered å¡ç‰‡ï¼Œé¼ æ ‡ç§»åŠ¨æ—¶æ›´æ–°æ‚¬æµ®çŠ¶æ€
        if (currentHoveredCard) {
          updateHoverState();
        }
      });

      // æ»šåŠ¨åœæ­¢æ£€æµ‹å®šæ—¶å™¨
      let scrollTimeout = null;
      const skillList = document.getElementById('skillList');
      let currentHoveredCard = null;

      // æ›´æ–°æ‚¬æµ®çŠ¶æ€çš„æ ¸å¿ƒå‡½æ•°
      function updateHoverState() {
        // è·å–å½“å‰é¼ æ ‡ä½ç½®ä¸‹çš„å…ƒç´ 
        const elementUnderMouse = document.elementFromPoint(lastMouseX, lastMouseY);
        if (!elementUnderMouse) {
          if (currentHoveredCard) {
            currentHoveredCard.classList.remove('hovered');
            currentHoveredCard = null;
          }
          return;
        }

        // å‘ä¸ŠæŸ¥æ‰¾ .skill-card å…ƒç´ 
        const skillCard = elementUnderMouse.closest('.skill-card');
        
        // å¦‚æœæ‚¬æµ®çš„å¡ç‰‡æ²¡å˜ï¼Œä¸éœ€è¦æ›´æ–°
        if (skillCard === currentHoveredCard) {
          return;
        }

        // ç§»é™¤æ—§å¡ç‰‡çš„æ‚¬æµ®çŠ¶æ€
        if (currentHoveredCard) {
          currentHoveredCard.classList.remove('hovered');
        }

        // è®¾ç½®æ–°å¡ç‰‡çš„æ‚¬æµ®çŠ¶æ€
        if (skillCard) {
          skillCard.classList.add('hovered');
        }
        currentHoveredCard = skillCard;
      }

      // æ»šè½®æ»šåŠ¨æ—¶å¼ºåˆ¶æ›´æ–°æ‚¬æµ®çŠ¶æ€
      function onScroll() {
        // æ·»åŠ  scrolling ç±»ï¼Œç¦ç”¨ CSS :hover
        skillList.classList.add('scrolling');

        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
        if (scrollTimeout) {
          clearTimeout(scrollTimeout);
        }

        // ç›´æ¥åŒæ­¥æ›´æ–°æ‚¬æµ®çŠ¶æ€ï¼Œæ— ä»»ä½•å»¶è¿Ÿ
        updateHoverState();

        // æ»šåŠ¨åœæ­¢ååªç§»é™¤ scrolling ç±»ï¼Œä¿ç•™ hovered ç±»è®©å¡ç‰‡ç»§ç»­æ‚¬æµ®
        scrollTimeout = setTimeout(() => {
          skillList.classList.remove('scrolling');
          // ä¸ç§»é™¤ hovered ç±»ï¼Œè®©å½“å‰å¡ç‰‡ä¿æŒæ‚¬æµ®çŠ¶æ€
          // hovered ç±»ä¼šåœ¨é¼ æ ‡ç§»åŠ¨åˆ°å…¶ä»–å¡ç‰‡æˆ–ç¦»å¼€åˆ—è¡¨æ—¶è‡ªåŠ¨æ›´æ–°
        }, 80);
      }

      // åŒæ—¶ç›‘å¬ wheel å’Œ scroll äº‹ä»¶ï¼Œç¡®ä¿æœ€å¤§çµæ•åº¦
      document.addEventListener('wheel', onScroll, { passive: true });
      document.addEventListener('scroll', onScroll, { passive: true, capture: true });

      // é¼ æ ‡ç¦»å¼€å¡ç‰‡åˆ—è¡¨æ—¶ç§»é™¤ hovered ç±»å’Œ scrolling ç±»
      skillList.addEventListener('mouseleave', () => {
        skillList.classList.remove('scrolling');
        if (currentHoveredCard) {
          currentHoveredCard.classList.remove('hovered');
          currentHoveredCard = null;
        }
      });


      window.addEventListener("message", (event) => {
        const message = event.data;
        switch (message.command) {
          case "updateSkills":
            skills = message.skills;
            const loader = document.getElementById("loader");
            if (loader) loader.style.display = "none";

            // å¤„ç†é¢‘ç‡é™åˆ¶æç¤º
            const banner = document.getElementById("warningBanner");
            if (banner) {
              banner.style.display = message.isRateLimited ? "flex" : "none";
            }

            updateUI();
            break;
          case "updateAccentColor":
            document.documentElement.style.setProperty(
              "--accent-color",
              message.color
            );
            const glowColor = message.color
              .replace("rgb", "rgba")
              .replace(")", ", 0.3)");
            document.documentElement.style.setProperty(
              "--accent-glow",
              glowColor
            );
            break;
          case "resetLang":
            document.getElementById("langSelect").value = "";
            break;
          case "translationProgress":
            const progressContainer = document.getElementById(
              "translationProgress"
            );
            const progressFill = document.getElementById("progressFill");
            const progressPercent = document.getElementById("progressPercent");

            if (progressContainer && progressFill && progressPercent) {
              progressContainer.style.display = "block";
              progressFill.style.width = message.progress + "%";
              progressPercent.innerText = message.progress + "%";

              if (message.finished) {
                setTimeout(() => {
                  progressContainer.style.opacity = "0";
                  setTimeout(() => {
                    progressContainer.style.display = "none";
                    progressContainer.style.opacity = "1";
                  }, 300);
                }, 1000);
              }
            }
            break;
        }
      });
    </script>
  </body>
</html>
